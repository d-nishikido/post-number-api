# 住所取得API 概要設計書

## 1. プロジェクト概要

### 1.1 目的
郵便番号を入力として住所情報を取得するRESTful APIを提供し、Webアプリケーションやモバイルアプリケーションから利用可能なサービスを構築する。

### 1.2 システム概要
- 日本郵便の公開データ（utf_ken_all.csv）を取り込み、PostgreSQLデータベースに格納
- 郵便番号をキーとした高速検索API提供
- Docker環境での運用とCI/CDパイプラインによる自動デプロイ

### 1.3 対象ユーザー
- Webアプリケーション開発者
- モバイルアプリケーション開発者
- 社内システム開発者

## 2. システム要件

### 2.1 機能要件

#### 2.1.1 住所データ取込機能
- **F001**: 日本郵便CSVデータの一括取込
- **F002**: 差分データの取込（データ更新対応）
- **F003**: 取込データのバリデーション
- **F004**: 取込処理のログ出力

#### 2.1.2 住所検索API
- **F005**: 郵便番号による住所検索
- **F006**: 部分一致検索（前方一致）
- **F007**: 検索結果のJSON形式出力
- **F008**: エラーハンドリングと適切なHTTPステータス返却

### 2.2 非機能要件

#### 2.2.1 性能要件
- **NF001**: レスポンス時間 100ms以内（95%tile）
- **NF002**: 同時接続数 1000コネクション
- **NF003**: スループット 1000 req/sec

#### 2.2.2 可用性要件
- **NF004**: 稼働率 99.9%以上
- **NF005**: 計画停止時間を除く24時間365日運用

#### 2.2.3 セキュリティ要件
- **NF006**: SQLインジェクション対策
- **NF007**: レート制限（100req/min/IP）
- **NF008**: ログ監査機能

#### 2.2.4 運用要件
- **NF009**: ヘルスチェック機能
- **NF010**: メトリクス監視機能
- **NF011**: 自動デプロイ機能

## 3. システム構成

### 3.1 全体アーキテクチャ

```
[Client] → [Nginx] → [Node.js API] → [PostgreSQL]
                  ↓
              [Monitoring]
```

### 3.2 技術スタック

| 層 | 技術 | バージョン | 用途 |
|---|---|---|---|
| リバースプロキシ | Nginx | 1.24+ | 負荷分散、SSL終端 |
| アプリケーション | Node.js | 18+ | API サーバー |
| フレームワーク | Express.js | 4.18+ | Web フレームワーク |
| 言語 | TypeScript | 5.0+ | 型安全性確保 |
| データベース | PostgreSQL | 15+ | データ永続化 |
| コンテナ | Docker | 24+ | 環境統一 |
| オーケストレーション | Docker Compose | 2.0+ | 開発環境構築 |

### 3.3 インフラ構成

#### 3.3.1 開発環境
- Docker Compose による単一ホスト構成
- ローカル開発用PostgreSQL
- ホットリロード対応

#### 3.3.2 ステージング環境
- クラウド環境（AWS/GCP/Azure）
- 本番同等構成
- CI/CDパイプライン連携

#### 3.3.3 本番環境
- 高可用性構成
- ロードバランサー配置
- データベースレプリケーション

## 4. データベース設計

### 4.1 論理設計

#### 4.1.1 エンティティ関連図
```
[addresses]
- id (PK)
- zipcode
- prefecture
- city
- town
- created_at
- updated_at

[import_logs]
- id (PK)
- filename
- import_date
- record_count
- status
```

### 4.2 物理設計

#### 4.2.1 addressesテーブル
| カラム名 | データ型 | 制約 | 説明 |
|---|---|---|---|
| id | SERIAL | PRIMARY KEY | 主キー |
| zipcode | VARCHAR(7) | NOT NULL | 郵便番号（7桁） |
| prefecture | VARCHAR(50) | NOT NULL | 都道府県名 |
| city | VARCHAR(100) | NOT NULL | 市区町村名 |
| town | VARCHAR(200) | NULL | 町域名 |
| created_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | 作成日時 |
| updated_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | 更新日時 |

#### 4.2.2 import_logsテーブル
| カラム名 | データ型 | 制約 | 説明 |
|---|---|---|---|
| id | SERIAL | PRIMARY KEY | 主キー |
| filename | VARCHAR(255) | NOT NULL | 取込ファイル名 |
| import_date | TIMESTAMP | NOT NULL | 取込実行日時 |
| record_count | INTEGER | NOT NULL | 取込レコード数 |
| status | VARCHAR(20) | NOT NULL | 処理状況 |

#### 4.2.3 インデックス設計
```sql
-- 郵便番号検索用（主要）
CREATE INDEX idx_addresses_zipcode ON addresses(zipcode);

-- 都道府県検索用
CREATE INDEX idx_addresses_prefecture ON addresses(prefecture);

-- 複合検索用
CREATE INDEX idx_addresses_pref_city ON addresses(prefecture, city);
```

## 5. API設計

### 5.1 RESTful API仕様

#### 5.1.1 ベースURL
```
https://api.example.com/v1
```

#### 5.1.2 エンドポイント一覧

| メソッド | パス | 説明 | 認証 |
|---|---|---|---|
| GET | /health | ヘルスチェック | 不要 |
| GET | /address/:zipcode | 郵便番号検索 | 不要 |
| GET | /address/search | 住所検索 | 不要 |

### 5.2 API詳細仕様

#### 5.2.1 郵便番号検索 API

**リクエスト**
```
GET /v1/address/1000001
```

**レスポンス（成功）**
```json
{
  "status": "success",
  "data": [
    {
      "zipcode": "1000001",
      "prefecture": "東京都",
      "city": "千代田区",
      "town": "千代田"
    }
  ],
  "meta": {
    "total": 1,
    "processing_time": "0.023s"
  }
}
```

**レスポンス（エラー）**
```json
{
  "status": "error",
  "error": {
    "code": "INVALID_ZIPCODE",
    "message": "郵便番号の形式が正しくありません",
    "details": "7桁の数字で入力してください"
  }
}
```

#### 5.2.2 住所検索 API

**リクエスト**
```
GET /v1/address/search?prefecture=東京都&city=千代田区
```

**レスポンス**
```json
{
  "status": "success",
  "data": [
    {
      "zipcode": "1000001",
      "prefecture": "東京都",
      "city": "千代田区",
      "town": "千代田"
    }
  ],
  "meta": {
    "total": 1,
    "page": 1,
    "per_page": 20,
    "processing_time": "0.045s"
  }
}
```

### 5.3 エラーコード定義

| コード | HTTP Status | 説明 |
|---|---|---|
| INVALID_ZIPCODE | 400 | 郵便番号形式エラー |
| NOT_FOUND | 404 | 該当データなし |
| RATE_LIMIT_EXCEEDED | 429 | レート制限超過 |
| INTERNAL_ERROR | 500 | 内部サーバーエラー |

## 6. セキュリティ設計

### 6.1 脅威分析

| 脅威 | リスクレベル | 対策 |
|---|---|---|
| SQLインジェクション | 高 | パラメータ化クエリ |
| DoS攻撃 | 中 | レート制限 |
| データ漏洩 | 中 | アクセスログ監視 |

### 6.2 セキュリティ対策

#### 6.2.1 アプリケーションレベル
- 入力値検証・サニタイゼーション
- SQLインジェクション対策（ORM使用）
- XSS対策ヘッダー設定
- レート制限実装

#### 6.2.2 インフラレベル
- HTTPS通信強制
- セキュリティヘッダー設定
- ファイアウォール設定
- アクセスログ監視

## 7. 運用設計

### 7.1 監視項目

#### 7.1.1 アプリケーション監視
- レスポンス時間
- エラー率
- スループット
- メモリ使用量

#### 7.1.2 インフラ監視
- CPU使用率
- メモリ使用率
- ディスク使用量
- ネットワーク転送量

### 7.2 ログ設計

#### 7.2.1 アクセスログ
```json
{
  "timestamp": "2025-07-29T10:30:00Z",
  "method": "GET",
  "path": "/v1/address/1000001",
  "status": 200,
  "response_time": 23,
  "ip": "192.168.1.100",
  "user_agent": "Mozilla/5.0..."
}
```

#### 7.2.2 エラーログ
```json
{
  "timestamp": "2025-07-29T10:30:00Z",
  "level": "error",
  "message": "Database connection failed",
  "error": "Connection timeout",
  "stack_trace": "...",
  "request_id": "req-123456"
}
```

### 7.3 バックアップ・復旧

#### 7.3.1 バックアップ戦略
- データベース: 日次フルバックアップ
- ログファイル: 週次アーカイブ
- 設定ファイル: Git管理

#### 7.3.2 復旧手順
1. システム停止
2. データベース復元
3. アプリケーション再起動
4. 動作確認

## 8. テスト戦略

### 8.1 テスト種別

| テスト種別 | 対象 | ツール | 実行タイミング |
|---|---|---|---|
| 単体テスト | 関数・メソッド | Jest | コミット時 |
| 統合テスト | API エンドポイント | Supertest | PR作成時 |
| 性能テスト | システム全体 | k6 | デプロイ前 |
| セキュリティテスト | 脆弱性 | OWASP ZAP | 週次 |

### 8.2 テストデータ
- 本番データのサンプリング（個人情報除去）
- 境界値テストデータ
- 異常系テストデータ

## 9. デプロイメント設計

### 9.1 CI/CDパイプライン

```
[Git Push] → [Build] → [Test] → [Deploy to Staging] → [Test] → [Deploy to Production]
```

### 9.2 デプロイ戦略
- Blue-Green デプロイメント
- ヘルスチェック連動
- 自動ロールバック機能

## 10. 移行計画

### 10.1 初期データ移行
1. utf_ken_all.csv ダウンロード
2. データクレンジング
3. バッチ取込実行
4. データ整合性確認

### 10.2 定期更新
- 月次での差分データ取込
- 更新通知機能
- 取込結果レポート

## 11. リスク管理

### 11.1 技術リスク

| リスク項目 | 影響度 | 発生確率 | 対策 |
|---|---|---|---|
| データベース障害 | 高 | 低 | レプリケーション |
| API性能劣化 | 中 | 中 | キャッシュ導入 |
| セキュリティ脆弱性 | 高 | 低 | 定期診断 |

### 11.2 運用リスク

| リスク項目 | 影響度 | 発生確率 | 対策 |
|---|---|---|---|
| データ更新遅延 | 中 | 中 | 自動化 |
| 運用ミス | 中 | 中 | 手順書整備 |
| 障害対応遅延 | 高 | 低 | 監視強化 |

## 12. スケジュール

### 12.1 開発工程

| フェーズ | 期間 | 成果物 |
|---|---|---|
| 詳細設計 | 2週間 | 詳細設計書 |
| 開発・単体テスト | 4週間 | ソースコード |
| 統合テスト | 2週間 | テスト結果 |
| システムテスト | 2週間 | テスト結果 |
| 本番リリース | 1週間 | 本番環境 |

### 12.2 運用開始後
- 1週間後: 初期監視・調整
- 1ヶ月後: 運用レビュー
- 3ヶ月後: 性能評価・改善

---

**文書情報**
- 作成日: 2025年7月29日
- バージョン: 1.0
- 作成者: システム開発チーム
- 承認者: プロジェクトマネージャー